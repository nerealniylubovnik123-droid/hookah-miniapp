<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Кальянный Миксер — Enhanced Stable</title>
  <style>
    :root{
      --bg:#000;
      --panel:#0c0c0c;
      --panel-2:#151515;
      --border:#242424;
      --text:#fff;
      --muted:#f0e9db;
      --accent:#f0b85a;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter, system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .container{max-width:420px;margin:0 auto;padding:16px;display:grid;gap:16px}
    header.title{font-weight:700;text-align:center;color:var(--muted);font-size:20px}
    .tabs{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;background:var(--panel-2);padding:6px;border-radius:14px}
    .tab-btn{background:transparent;border:none;color:#fff;padding:10px 12px;border-radius:10px;cursor:pointer;transition:.15s transform,.2s background,.2s color}
    .tab-btn:hover{transform:translateY(-1px)}
    .tab-btn:active{transform:translateY(0) scale(.98)}
    .tab-btn.active{background:var(--accent);color:#000}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px}
    .card .hd{padding:14px 14px 0 14px}
    .card .hd h3{margin:0 0 2px 0;font-size:18px}
    .card .hd .desc{margin:0 0 10px 0;font-size:12px;color:rgba(240,233,219,.7)}
    .card .bd{padding:12px 14px 14px 14px}
    .btn{background:#1f1f1f;border:1px solid #2a2a2a;color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer;transition:.15s transform,.2s background,.2s color,.2s border}
    .btn:hover{transform:translateY(-1px)}
    .btn:active{transform:translateY(0) scale(.98)}
    .btn.accent{background:var(--accent);color:#000;border-color:var(--accent)}
    .btn.small{padding:4px 8px;font-size:12px;border-radius:8px}
    .btn.ghost{background:transparent;border-color:#2a2a2a}
    .btn.danger{background:#3a0d0d;border-color:#5a1a1a;color:#ffbaba}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .grid{display:grid;gap:8px}
    .brand-btn{background:var(--panel-2);border:1px solid var(--border);border-radius:12px;padding:12px;color:var(--text);cursor:pointer;transition:.15s transform,.2s background,.2s color,.2s border;text-align:center}
    .brand-btn:hover{transform:translateY(-1px)}
    .brand-btn:active{transform:translateY(0) scale(.98)}
    .brand-btn.active{background:var(--accent);border-color:var(--accent);color:#000}
    .row{display:flex;gap:8px;align-items:center}
    .row.between{justify-content:space-between}
    .space{height:8px}
    .input{width:100%;background:var(--panel-2);border:1px solid var(--border);color:#fff;border-radius:10px;padding:10px}
    .mix-card{background:var(--panel-2);border:1px solid var(--border);border-radius:12px;padding:10px}
    .tiny{font-size:11px}
    .muted{opacity:.75}
    .sep{height:1px;background:var(--border);margin:8px 0}
    .taste-line{font-size:13px;opacity:.92}
    .flavor-item{display:flex;justify-content:space-between;align-items:center;background:var(--panel-2);border:1px solid var(--border);border-radius:12px;padding:10px}
    input[type=range]{width:100%;accent-color:var(--accent)}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:3px 8px;border-radius:999px;border:1px solid var(--border);background:var(--panel-2);font-size:11px}
    .badge.hidden{border-color:#503333;background:#2a1a1a;color:#ffbaba}
    .badge.ok{border-color:#2c4737;background:#16271d;color:#bff5d6}
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>
  <script type="text/babel" data-presets="react">
    const {useState,useMemo,useEffect} = React;
    const load=(k,f)=>{try{const r=localStorage.getItem(k);return r?JSON.parse(r):f}catch{return f}};
    const save=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}};
    const slug=s=>s.toLowerCase().trim().split(' ').filter(Boolean).join('-').normalize('NFKD').replace(/[^a-zа-я0-9-]/gi,'');
    const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
    const calcAvg=ps=>Math.round(ps.reduce((a,b)=>a+b.percent*b.strength,0)/ps.reduce((a,b)=>a+b.percent,0));
    const useDebouncedValue=(value,delay=220)=>{const [v,setV]=useState(value);useEffect(()=>{const id=setTimeout(()=>setV(value),delay);return()=>clearTimeout(id)},[value,delay]);return v};
    function smartDesc(parts){
      if(!parts.length)return"";
      const s=[...parts].sort((a,b)=>b.percent-a.percent);
      const base=s.slice(0,2).map(t=>t.taste.split(",").map(x=>x.trim()).join(" + ")).join(" и ");
      const acc=s.slice(2,4); const accStr=acc.length?(" с оттенками "+acc.map(t=>t.taste.split(",").map(x=>x.trim()).join(" + ")).join(" и ")):"";
      const avg=Math.round(s.reduce((a,x)=>a+x.strength*x.percent,0)/s.reduce((a,x)=>a+x.percent,0));
      const tone=avg>=7?"насыщенный":avg>=5?"выразительный":avg>=3?"мягкий":"лёгкий";
      return `${tone} микс: ${base}${accStr}`;
    }
    function App(){
      const [tab,setTab]=useState('community');

      const seed=[
        {id:"alfakher",name:"Al Fakher",hidden:false,flavors:[
          {id:"mint",name:"Mint",strength:2,taste:"свежий, мятный",hidden:false},
          {id:"grape",name:"Grape",strength:2,taste:"фруктовый, виноградный",hidden:false},
          {id:"double-apple",name:"Double Apple",strength:3,taste:"анисовый, яблочный",hidden:false}
        ]},
        {id:"musthave",name:"Must Have",hidden:false,flavors:[
          {id:"raspberry",name:"Raspberry",strength:3,taste:"ягодный, кисловатый",hidden:false},
          {id:"cheesecake",name:"Cheesecake",strength:4,taste:"десертный, сливочный",hidden:false},
          {id:"whiskey-cola",name:"Whiskey Cola",strength:5,taste:"алкогольный, кола",hidden:false}
        ]},
        {id:"darkside",name:"Darkside",hidden:false,flavors:[
          {id:"pear",name:"Pear",strength:5,taste:"грушевый, сочный",hidden:false},
          {id:"cola",name:"Cola",strength:5,taste:"карамельный",hidden:false},
          {id:"spiced-rum",name:"Spiced Rum",strength:7,taste:"пряный, алкогольный",hidden:false}
        ]}
      ];
      const [brands,setBrands]=useState(()=>load("h.brands.v3",seed));
      const [banned,setBanned]=useState(()=>load("h.banned",[]));
      const [mixes,setMixes]=useState(()=>load("h.mixes.v3",[]));
      useEffect(()=>save("h.brands.v3",brands),[brands]);useEffect(()=>save("h.banned",banned),[banned]);useEffect(()=>save("h.mixes.v3",mixes),[mixes]);
      useEffect(()=>{if(mixes.length===0){const m1=[
        {key:"musthave:raspberry",brandId:"musthave",flavorId:"raspberry",name:"Raspberry",percent:60,strength:3,taste:"ягодный, кисловатый"},
        {key:"alfakher:mint",brandId:"alfakher",flavorId:"mint",name:"Mint",percent:40,strength:2,taste:"свежий, мятный"}
      ];const m2=[
        {key:"alfakher:double-apple",brandId:"alfakher",flavorId:"double-apple",name:"Double Apple",percent:50,strength:3,taste:"анисовый, яблочный"},
        {key:"darkside:spiced-rum",brandId:"darkside",flavorId:"spiced-rum",name:"Spiced Rum",percent:50,strength:7,taste:"пряный, алкогольный"}
      ];setMixes([{id:"ex1",title:"Лесные ягоды",author:"Гость Аня",parts:m1,avgStrength:calcAvg(m1),likes:0,createdAt:Date.now()},{id:"ex2",title:"Яблочный пряный",author:"Гость Макс",parts:m2,avgStrength:calcAvg(m2),likes:0,createdAt:Date.now()}])}},[]);

      // community
      const DIR=["десертный","кислый","травяной","пряный","чайный","сладкий","свежий","алкогольный","гастрономический"];
      const [pref,setPref]=useState('all'); const [strength,setStrength]=useState(5); const [likes,setLikes]=useState({});
      const rec=mixes.filter(m=>pref==='all'||m.parts.some(p=>p.taste.toLowerCase().includes(pref))).filter(m=>Math.abs(m.avgStrength-strength)<=1);
      const toggleLike=id=>{setMixes(ms=>ms.map(m=>m.id===id?{...m,likes:m.likes+(likes[id]?-1:1)}:m));setLikes(s=>{const n={...s};if(n[id])delete n[id];else n[id]=1;return n})};

      // builder
      const [selected,setSelected]=useState(null);
      const [search,setSearch]=useState(""); const searchDeb=useDebouncedValue(search,220);
      const [parts,setParts]=useState([]);
      const selectedBrand=useMemo(()=>brands.find(b=>b.id===selected)||null,[selected,brands]);
      const total=parts.reduce((a,b)=>a+b.percent,0);
      const avg=parts.length&&total>0?Math.round(parts.reduce((a,p)=>a+p.percent*p.strength,0)/total):0;
      const remaining=Math.max(0,100-total);
      const visibleBrands=brands.filter(b=>!b.hidden);
      const filtered=selectedBrand?selectedBrand.flavors.filter(f=>!f.hidden).filter(f=>{
        const q=searchDeb.toLowerCase();return f.name.toLowerCase().includes(q)||f.taste.toLowerCase().includes(q);
      }):[];
      const addFlavor=(brandId,fl)=>{if(remaining<=0)return;const key=`${brandId}:${fl.id}`;setParts(prev=>{if(prev.some(p=>p.key===key))return prev;const defPct=Math.min(10,Math.max(0,100-prev.reduce((a,b)=>a+b.percent,0)));if(defPct<=0)return prev;return[...prev,{key,brandId,flavorId:fl.id,name:fl.name,taste:fl.taste,strength:fl.strength,percent:defPct}]})};
      const updatePct=(key,val)=>{setParts(prev=>{const sumOthers=prev.reduce((a,b)=>a+(b.key===key?0:b.percent),0);const allowed=Math.max(0,100-sumOthers);const clamped=clamp(Math.round(val),0,allowed);return prev.map(x=>x.key===key?{...x,percent:clamped}:x)})};
      const removePart=key=>setParts(prev=>prev.filter(x=>x.key!==key));
      const saveMix=()=>{if(total!==100)return;const id="mix-"+Date.now();setMixes(prev=>[{id,title:"Микс",description:"",parts,avgStrength:avg,likes:0,createdAt:Date.now(),author:"Гость"},...prev]);setParts([])};

      // global search
      const [gq,setGq]=useState(""); const gqd=useDebouncedValue(gq,220);
      const gresults=useMemo(()=>{const q=gqd.trim().toLowerCase();if(!q)return[];return brands.filter(b=>!b.hidden).map(b=>({brand:b,flavors:b.flavors.filter(f=>!f.hidden).filter(f=>f.name.toLowerCase().includes(q)||f.taste.toLowerCase().includes(q))})).filter(g=>g.flavors.length>0)},[gqd,brands]);

      // admin
      const [brandName,setBrandName]=useState(""); const [brandForFlavor,setBrandForFlavor]=useState(brands[0]?.id||"");
      const [flavorName,setFlavorName]=useState(""); const [flavorStrength,setFlavorStrength]=useState(5); const [flavorTaste,setFlavorTaste]=useState("");
      const [banInput,setBanInput]=useState("");
      const addBrand=()=>{const name=brandName.trim();if(!name)return;const id=slug(name);if(brands.some(b=>b.id===id))return;const next=[...brands,{id,name,hidden:false,flavors:[]}];setBrands(next);setBrandName("");if(!brandForFlavor)setBrandForFlavor(id)};
      const addFlavorAdmin=()=>{const b=brands.find(x=>x.id===brandForFlavor);if(!b)return;const name=flavorName.trim();if(!name)return;const id=slug(name);if(b.flavors.some(f=>f.id===id))return;const st=clamp(Math.round(flavorStrength),1,10);const fl={id,name,strength:st,taste:flavorTaste.trim(),hidden:false};setBrands(brands.map(x=>x.id===b.id?{...x,flavors:[...x.flavors,fl]}:x))};
      const toggleBrandHidden=id=>setBrands(prev=>prev.map(b=>b.id===id?{...b,hidden:!b.hidden}:b));
      const toggleFlavorHidden=(bid,fid)=>setBrands(prev=>prev.map(b=>b.id===bid?{...b,flavors:b.flavors.map(f=>f.id===fid?{...f,hidden:!f.hidden}:f)}:b));
      const delBrand=id=>{const next=brands.filter(b=>b.id!==id);setBrands(next);if(brandForFlavor===id)setBrandForFlavor(next[0]?.id||"");if(selected===id)setSelected(null)};
      const delFlavor=(bid,fid)=>setBrands(prev=>prev.map(b=>b.id!==bid?b:{...b,flavors:b.flavors.filter(f=>f.id!==fid)}));
      const addBan=()=>{const w=banInput.trim().toLowerCase();if(!w)return;if(banned.includes(w))return;setBanned([...banned,w])};
      const delBan=w=>setBanned(banned.filter(x=>x!==w));

      return <div className="container">
        <header className="title">Кальянный Миксер</header>
        <div className="tabs">{['community','builder','admin'].map(v=><button key={v} className={"tab-btn"+(tab===v?' active':'')} onClick={()=>setTab(v)}>{v==='community'?'Миксы':v==='builder'?'Конструктор':'Админ'}</button>)}</div>

        {tab==='community'&&<div className="card"><div className="hd"><h3>Рекомендации</h3><p className="desc">Выберите настроение и крепость</p></div><div className="bd">
          <div className="grid-2"><button className={"btn "+(pref==='all'?'accent':'')} onClick={()=>setPref('all')}>Все</button>{["десертный","кислый","травяной","пряный","чайный","сладкий","свежий","алкогольный","гастрономический"].map(t=><button key={t} className={"btn "+(pref===t?'accent':'')} onClick={()=>setPref(t)}>{t}</button>)}</div>
          <div className="space"></div><div>Крепость: <b>{strength}</b></div><input type="range" min="1" max="10" value={strength} onChange={e=>setStrength(parseInt(e.target.value))}/>
          <div className="sep"></div>
          <div className="grid">{rec.map(m=><div key={m.id} className="mix-card"><div className="row between"><div><div style={{fontWeight:600}}>{m.title}</div><div className="tiny muted">Микс от {m.author}</div></div><button className={"btn "+(likes[m.id]?'accent':'')} onClick={()=>toggleLike(m.id)}>❤ {m.likes}</button></div><div className="space"></div><div className="tiny">Крепость: <b>{m.avgStrength}</b></div><div className="taste-line">{smartDesc(m.parts)}</div><div className="tiny muted">Состав: {m.parts.map(p=>p.name+" "+p.percent+"%").join(' + ')}</div></div>)}</div>
        </div></div>}

        {tab==='builder'&&<>
          <div className="card"><div className="hd"><h3>Глобальный поиск</h3><p className="desc">Ищет по всем брендам, сгруппировано</p></div><div className="bd">
            <input className="input" placeholder="Поиск по всем вкусам..." value={gq} onChange={e=>setGq(e.target.value)}/>
            <div className="space"></div>
            <div className="grid">{gqd&&gresults.length===0&&<div className="tiny muted">Ничего не найдено</div>}{gresults.map(g=><div key={g.brand.id} className="mix-card"><div className="row between"><div><b>{g.brand.name}</b></div>{g.brand.hidden?<span className="badge hidden">скрыт</span>:<span className="badge ok">доступен</span>}</div><div className="space"></div><div className="grid">{g.flavors.map(f=><div key={f.id} className="flavor-item"><div><div style={{fontWeight:600}}>{f.name}</div><div className="tiny muted">крепость: {f.strength} • вкус: {f.taste}</div></div><button className="btn" onClick={()=>addFlavor(g.brand.id,f)}>+ в микс</button></div>)}</div></div>)}</div>
          </div></div>

          <div className="card"><div className="hd"><h3>Бренды</h3><p className="desc">Выбор бренда</p></div><div className="bd"><div className="grid-2">{visibleBrands.map(b=><button key={b.id} className={"brand-btn"+(selected===b.id?' active':'')} onClick={()=>setSelected(b.id)}>{b.name}</button>)}</div></div></div>

          {selectedBrand&&<div className="card"><div className="hd"><h3>Вкусы — {selectedBrand.name}</h3></div><div className="bd"><input className="input" placeholder="Поиск в бренде..." value={search} onChange={e=>setSearch(e.target.value)}/><div className="space"></div><div className="grid">{filtered.map(f=><div key={f.id} className="flavor-item"><div><div style={{fontWeight:600}}>{f.name}</div><div className="tiny muted">крепость: {f.strength} • вкус: {f.taste}</div></div><button className="btn" onClick={()=>addFlavor(selectedBrand.id,f)}>+ в микс</button></div>)}</div></div></div>}

          <div className="card"><div className="hd"><h3>Ваш микс</h3><p className="desc">Сумма должна быть 100%.</p></div><div className="bd">
            {parts.length===0&&<div className="tiny muted">Добавьте вкусы из списка выше.</div>}
            <div className="grid">{parts.map(p=><div key={p.key} className="mix-card"><div className="row between"><div><div style={{fontWeight:600}}>{p.name}</div><div className="tiny muted">крепость: {p.strength} • вкус: {p.taste}</div></div><button className="btn" onClick={()=>removePart(p.key)}>удалить</button></div><div className="space"></div><input type="range" min="0" max="100" step="5" value={p.percent} onChange={e=>updatePct(p.key,parseInt(e.target.value))}/><div className="row between tiny muted"><span>0%</span><span>{p.percent}%</span><span>100%</span></div></div>)}</div>
            <div className="sep"></div><div className="row between"><div>Сумма: <b>{total}%</b> (осталось: <b>{Math.max(0,100-total)}%</b>)</div><div className="muted">крепость: <b>{avg||0}</b></div></div>
            <div className="space"></div><div className="row" style={{justifyContent:'flex-end'}}><button className="btn accent" onClick={saveMix}>Сохранить микс</button></div>
          </div></div>

          <div className="card"><div className="hd"><h3>Итоговый вкус</h3><p className="desc">Короткое описание</p></div><div className="bd">{parts.length===0?<div className="muted">Ещё нет выбранных вкусов.</div>:<div className="taste-line">{smartDesc(parts)}</div>}</div></div>
        </>}

        {tab==='admin'&&<>
          <div className="card"><div className="hd"><h3>Бренды</h3><p className="desc">Добавление / скрытие / удаление</p></div><div className="bd">
            <div className="row"><input className="input" placeholder="Новый бренд" value={brandName} onChange={e=>setBrandName(e.target.value)}/><button className="btn" onClick={addBrand}>Добавить</button></div>
            <div className="space"></div>
            <div className="grid-2">{brands.map(b=><div key={b.id} className="mix-card"><div className="row between">
              <div><div style={{fontWeight:600}}>{b.name}</div><div className="tiny muted">вкусов: {b.flavors.length}</div>{b.hidden?<div className="badge hidden">скрыт</div>:<div className="badge ok">доступен</div>}</div>
              <div className="grid"><button className="btn small ghost" onClick={()=>toggleBrandHidden(b.id)}>{b.hidden?"показать":"скрыть"}</button><button className="btn small danger" onClick={()=>delBrand(b.id)}>удалить</button></div>
            </div></div>)}</div>
          </div></div>

          <div className="card"><div className="hd"><h3>Вкусы</h3><p className="desc">Добавление / скрытие / удаление</p></div><div className="bd">
            <div className="grid-2"><select className="input" value={brandForFlavor} onChange={e=>setBrandForFlavor(e.target.value)}>{brands.map(b=><option key={b.id} value={b.id}>{b.name}</option>)}</select><input className="input" placeholder="Название вкуса" value={flavorName} onChange={e=>setFlavorName(e.target.value)}/></div>
            <div className="space"></div>
            <div className="row between"><div>Крепость: <b>{flavorStrength}</b></div><input type="range" min="1" max="10" value={flavorStrength} onChange={e=>setFlavorStrength(parseInt(e.target.value))}/></div>
            <div className="space"></div>
            <input className="input" placeholder="Описание вкуса (направления)" value={flavorTaste} onChange={e=>setFlavorTaste(e.target.value)}/>
            <div className="space"></div>
            <div className="row" style={{justifyContent:'flex-end'}}><button className="btn" onClick={addFlavorAdmin}>Добавить вкус</button></div>
            {brands.find(b=>b.id===brandForFlavor)&&<><div className="sep"></div><div className="muted">Вкусы бренда: {brands.find(b=>b.id===brandForFlavor).name}</div><div className="space"></div><div className="grid">{brands.find(b=>b.id===brandForFlavor).flavors.map(f=><div key={f.id} className="flavor-item"><div><div style={{fontWeight:600}}>{f.name}</div><div className="tiny muted">крепость: {f.strength} • вкус: {f.taste}</div>{f.hidden&&<div className="badge hidden">скрыт</div>}</div><div className="row"><button className="btn small ghost" onClick={()=>toggleFlavorHidden(brandForFlavor,f.id)}>{f.hidden?"показать":"скрыть"}</button><button className="btn small danger" onClick={()=>delFlavor(brandForFlavor,f.id)}>удалить</button></div></div>)}</div></>}
          </div></div>

          <div className="card"><div className="hd"><h3>Запрещённые слова</h3></div><div className="bd">
            <div className="row"><input className="input" placeholder="например: 18+" value={banInput} onChange={e=>setBanInput(e.target.value)}/><button className="btn" onClick={addBan}>Добавить</button></div>
            <div className="space"></div>
            <div className="row" style={{flexWrap:'wrap',gap:'8px'}}>{banned.length===0&&<div className="muted tiny">Пусто</div>}{banned.map(w=><div key={w} className="badge">{w} <button className="btn tiny ghost" style={{marginLeft:'6px',padding:'2px 6px'}} onClick={()=>delBan(w)}>удалить</button></div>)}</div>
          </div></div>
        </>}
      </div>;
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
</body>
</html>