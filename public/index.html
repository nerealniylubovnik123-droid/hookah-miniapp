<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ö–∞–ª—å—è–Ω–Ω—ã–π –ú–∏–∫—Å–µ—Ä ‚Äî Enhanced Stable</title>

  <!-- ‚úÖ Telegram WebApp SDK (–∫–∞–∫ –≤ —Å—Ç–∞—Ä–æ–º —Ä–∞–±–æ—á–µ–º —Ñ–∞–π–ª–µ) -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{
      --bg:#000; --panel:#0c0c0c; --panel-2:#151515; --border:#242424;
      --text:#fff; --muted:#f0e9db; --accent:#f0b85a;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .container{max-width:420px;margin:0 auto;padding:16px;display:grid;gap:16px}
    header.title{font-weight:700;text-align:center;color:var(--muted);font-size:20px}
    .tabs{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;background:var(--panel-2);padding:6px;border-radius:14px}
    .tab-btn{background:transparent;border:none;color:#fff;padding:10px 12px;border-radius:10px;cursor:pointer;transition:.15s transform,.2s background,.2s color}
    .tab-btn:hover{transform:translateY(-1px)} .tab-btn:active{transform:translateY(0) scale(.98)}
    .tab-btn.active{background:var(--accent);color:#000}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:16px}
    .card .hd{padding:14px 14px 0 14px} .card .hd h3{margin:0 0 2px 0;font-size:18px}
    .card .hd .desc{margin:0 0 10px 0;font-size:12px;color:rgba(240,233,219,.7)}
    .card .bd{padding:12px 14px 14px 14px}
    .btn{background:#1f1f1f;border:1px solid #2a2a2a;color:#fff;border-radius:10px;padding:8px 10px;cursor:pointer;transition:.15s transform,.2s background,.2s color,.2s border}
    .btn:hover{transform:translateY(-1px)} .btn:active{transform:translateY(0) scale(.98)}
    .btn.accent{background:var(--accent);color:#000;border-color:var(--accent)} .btn.small{padding:4px 8px;font-size:12px;border-radius:8px}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:8px} .grid{display:grid;gap:8px}
    .brand-btn{background:var(--panel-2);border:1px solid var(--border);border-radius:12px;padding:12px;color:var(--text);cursor:pointer;transition:.15s transform,.2s background,.2s color,.2s border;text-align:center}
    .brand-btn:hover{transform:translateY(-1px)} .brand-btn:active{transform:translateY(0) scale(.98)} .brand-btn.active{background:var(--accent);border-color:var(--accent);color:#000}
    .row{display:flex;gap:8px;align-items:center} .row.between{justify-content:space-between}
    .space{height:8px}
    .input{width:100%;background:var(--panel-2);border:1px solid var(--border);color:#fff;border-radius:10px;padding:10px}
    .mix-card{background:var(--panel-2);border:1px solid var(--border);border-radius:12px;padding:10px}
    .tiny{font-size:11px} .muted{opacity:.75} .sep{height:1px;background:var(--border);margin:8px 0}
    .taste-line{font-size:13px;opacity:.92}
    .flavor-item{display:flex;justify-content:space-between;align-items:center;background:var(--panel-2);border:1px solid var(--border);border-radius:12px;padding:10px}
    input[type=range]{width:100%;accent-color:var(--accent)}
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React / ReactDOM / Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>

  <script type="text/babel" data-presets="react">
    const {useState,useMemo,useEffect} = React;

    // === AUTH: —Ñ—É–Ω–∫—Ü–∏—è –∏–∑ —Ç–≤–æ–µ–≥–æ —Å—Ç–∞—Ä–æ–≥–æ —Ñ–∞–π–ª–∞ (–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —á—Ç–µ–Ω–∏–µ Telegram WebApp) ===
    const state = {
      user: null,
      // (–æ—Å—Ç–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∏–∂–µ –ø–æ –∫–æ–¥—É)
    };

    function initAuth(){
      try{
        const u = window?.Telegram?.WebApp?.initDataUnsafe?.user;
        if(u){
          const name = [u.first_name,u.last_name].filter(Boolean).join(' ') || u.username || ('User '+u.id);
          state.user = { id:String(u.id), name, username:u.username };
          return;
        }
      }catch(_){}
      // fallback: –≥–æ—Å—Ç—å
      state.user = { id:'anon', name:'–ì–æ—Å—Ç—å' };
    }
    // –í–ê–ñ–ù–û: –≤—ã–∑—ã–≤–∞–µ–º –¥–æ —Å—Ç–∞—Ä—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    initAuth();

    // === –£—Ç–∏–ª–∏—Ç—ã –∏ –¥–∞–Ω–Ω—ã–µ (–∫–∞–∫ –≤ —Ç–≤–æ—ë–º –ø–µ—Ä–≤–æ–º —Ñ–∞–π–ª–µ) ===
    const load=(k,f)=>{try{const r=localStorage.getItem(k);return r?JSON.parse(r):f}catch{return f}};
    const save=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}};
    const slug=s=>s.toLowerCase().trim().split(' ').filter(Boolean).join('-').normalize('NFKD').replace(/[^a-z–∞-—è0-9-]/gi,'');
    const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
    const calcAvg=ps=>Math.round(ps.reduce((a,b)=>a+b.percent*b.strength,0)/ps.reduce((a,b)=>a+b.percent,0));

    function smartDesc(parts){
      if(!parts.length)return"";
      const s=[...parts].sort((a,b)=>b.percent-a.percent);
      const base=s.slice(0,2).map(t=>t.taste.split(",").map(x=>x.trim()).join(" + ")).join(" –∏ ");
      const acc=s.slice(2,4);
      const accStr=acc.length?(" —Å –æ—Ç—Ç–µ–Ω–∫–∞–º–∏ "+acc.map(t=>t.taste.split(",").map(x=>x.trim()).join(" + ")).join(" –∏ ")):"";
      const avg=Math.round(s.reduce((a,x)=>a+x.strength*x.percent,0)/s.reduce((a,x)=>a+x.percent,0));
      const tone=avg>=7?"–Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π":avg>=5?"–≤—ã—Ä–∞–∑–∏—Ç–µ–ª—å–Ω—ã–π":avg>=3?"–º—è–≥–∫–∏–π":"–ª—ë–≥–∫–∏–π";
      return `${tone} –º–∏–∫—Å: ${base}${accStr}`;
    }

    function App(){
      const IS_ADMIN = state?.user?.username === "Tutenhaman"; // üëà –∞–¥–º–∏–Ω –ø–æ username

      const [tab,setTab]=useState('community');

      const seed=[
        {id:"alfakher",name:"Al Fakher",hidden:false,flavors:[
          {id:"mint",name:"Mint",strength:2,taste:"—Å–≤–µ–∂–∏–π, –º—è—Ç–Ω—ã–π",hidden:false},
          {id:"grape",name:"Grape",strength:2,taste:"—Ñ—Ä—É–∫—Ç–æ–≤—ã–π, –≤–∏–Ω–æ–≥—Ä–∞–¥–Ω—ã–π",hidden:false},
          {id:"double-apple",name:"Double Apple",strength:3,taste:"–∞–Ω–∏—Å–æ–≤—ã–π, —è–±–ª–æ—á–Ω—ã–π",hidden:false}
        ]},
        {id:"musthave",name:"Must Have",hidden:false,flavors:[
          {id:"raspberry",name:"Raspberry",strength:3,taste:"—è–≥–æ–¥–Ω—ã–π, –∫–∏—Å–ª–æ–≤–∞—Ç—ã–π",hidden:false},
          {id:"cheesecake",name:"Cheesecake",strength:4,taste:"–¥–µ—Å–µ—Ä—Ç–Ω—ã–π, —Å–ª–∏–≤–æ—á–Ω—ã–π",hidden:false},
          {id:"whiskey-cola",name:"Whiskey Cola",strength:5,taste:"–∞–ª–∫–æ–≥–æ–ª—å–Ω—ã–π, –∫–æ–ª–∞",hidden:false}
        ]},
        {id:"darkside",name:"Darkside",hidden:false,flavors:[
          {id:"pear",name:"Pear",strength:5,taste:"–≥—Ä—É—à–µ–≤—ã–π, —Å–æ—á–Ω—ã–π",hidden:false},
          {id:"cola",name:"Cola",strength:5,taste:"–∫–∞—Ä–∞–º–µ–ª—å–Ω—ã–π",hidden:false},
          {id:"spiced-rum",name:"Spiced Rum",strength:7,taste:"–ø—Ä—è–Ω—ã–π, –∞–ª–∫–æ–≥–æ–ª—å–Ω—ã–π",hidden:false}
        ]}
      ];

      const [brands,setBrands]=useState(()=>load("h.brands.v3",seed));
      const [banned,setBanned]=useState(()=>load("h.banned",[]));
      const [mixes,setMixes]=useState(()=>load("h.mixes.v3",[]));
      useEffect(()=>save("h.brands.v3",brands),[brands]);
      useEffect(()=>save("h.banned",banned),[banned]);
      useEffect(()=>save("h.mixes.v3",mixes),[mixes]);

      useEffect(()=>{if(mixes.length===0){const m1=[
        {key:"musthave:raspberry",brandId:"musthave",flavorId:"raspberry",name:"Raspberry",percent:60,strength:3,taste:"—è–≥–æ–¥–Ω—ã–π, –∫–∏—Å–ª–æ–≤–∞—Ç—ã–π"},
        {key:"alfakher:mint",brandId:"alfakher",flavorId:"mint",name:"Mint",percent:40,strength:2,taste:"—Å–≤–µ–∂–∏–π, –º—è—Ç–Ω—ã–π"}
      ];const m2=[
        {key:"alfakher:double-apple",brandId:"alfakher",flavorId:"double-apple",name:"Double Apple",percent:50,strength:3,taste:"–∞–Ω–∏—Å–æ–≤—ã–π, —è–±–ª–æ—á–Ω—ã–π"},
        {key:"darkside:spiced-rum",brandId:"darkside",flavorId:"spiced-rum",name:"Spiced Rum",percent:50,strength:7,taste:"–ø—Ä—è–Ω—ã–π, –∞–ª–∫–æ–≥–æ–ª—å–Ω—ã–π"}
      ];setMixes([{id:"ex1",title:"–õ–µ—Å–Ω—ã–µ —è–≥–æ–¥—ã",author:"–ì–æ—Å—Ç—å –ê–Ω—è",parts:m1,avgStrength:calcAvg(m1),likes:0,createdAt:Date.now()},{id:"ex2",title:"–Ø–±–ª–æ—á–Ω—ã–π –ø—Ä—è–Ω—ã–π",author:"–ì–æ—Å—Ç—å –ú–∞–∫—Å",parts:m2,avgStrength:calcAvg(m2),likes:0,createdAt:Date.now()}])}},[]);

      // community
      const DIR=["–¥–µ—Å–µ—Ä—Ç–Ω—ã–π","–∫–∏—Å–ª—ã–π","—Ç—Ä–∞–≤—è–Ω–æ–π","–ø—Ä—è–Ω—ã–π","—á–∞–π–Ω—ã–π","—Å–ª–∞–¥–∫–∏–π","—Å–≤–µ–∂–∏–π","–∞–ª–∫–æ–≥–æ–ª—å–Ω—ã–π","–≥–∞—Å—Ç—Ä–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π"];
      const [pref,setPref]=useState('all'); const [strength,setStrength]=useState(5); const [likes,setLikes]=useState({});
      const rec=mixes.filter(m=>pref==='all'||m.parts.some(p=>p.taste.toLowerCase().includes(pref))).filter(m=>Math.abs(m.avgStrength-strength)<=1);
      const toggleLike=id=>{setMixes(ms=>ms.map(m=>m.id===id?{...m,likes:m.likes+(likes[id]?-1:1)}:m));setLikes(s=>{const n={...s};if(n[id])delete n[id];else n[id]=1;return n})};

      // builder
      const [selected,setSelected]=useState(null);
      const [search,setSearch]=useState(""); 
      const [parts,setParts]=useState([]);
      const selectedBrand=useMemo(()=>brands.find(b=>b.id===selected)||null,[selected,brands]);
      const total=parts.reduce((a,b)=>a+b.percent,0);
      const avg=parts.length&&total>0?Math.round(parts.reduce((a,p)=>a+p.percent*p.strength,0)/total):0;
      const remaining=Math.max(0,100-total);
      const visibleBrands=brands.filter(b=>!b.hidden);
      const filtered=selectedBrand?selectedBrand.flavors.filter(f=>!f.hidden).filter(f=>{
        const q=search.toLowerCase();return f.name.toLowerCase().includes(q)||f.taste.toLowerCase().includes(q);
      }):[];
      const addFlavor=(brandId,fl)=>{if(remaining<=0)return;const key=`${brandId}:${fl.id}`;setParts(prev=>{if(prev.some(p=>p.key===key))return prev;const defPct=Math.min(10,Math.max(0,100-prev.reduce((a,b)=>a+b.percent,0)));if(defPct<=0)return prev;return[...prev,{key,brandId,flavorId:fl.id,name:fl.name,taste:fl.taste,strength:fl.strength,percent:defPct}]})};
      const updatePct=(key,val)=>{setParts(prev=>{const sumOthers=prev.reduce((a,b)=>a+(b.key===key?0:b.percent),0);const allowed=Math.max(0,100-sumOthers);const clamped=clamp(Math.round(val),0,allowed);return prev.map(x=>x.key===key?{...x,percent:clamped}:x)})};
      const removePart=key=>setParts(prev=>prev.filter(x=>x.key!==key));
      const saveMix=()=>{if(total!==100)return;const id="mix-"+Date.now();setMixes(prev=>[{id,title:"–ú–∏–∫—Å",description:"",parts,avgStrength:avg,likes:0,createdAt:Date.now(),author:state.user?.name||"–ì–æ—Å—Ç—å"},...prev]);setParts([])};

      return (
        <div className="container">
          <header className="title">–ö–∞–ª—å—è–Ω–Ω—ã–π –ú–∏–∫—Å–µ—Ä</header>

          <div className="tabs">
            <button className={"tab-btn"+(tab==='community'?' active':'')} onClick={()=>setTab('community')}>–ú–∏–∫—Å—ã</button>
            <button className={"tab-btn"+(tab==='builder'?' active':'')} onClick={()=>setTab('builder')}>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</button>
            {IS_ADMIN && <button className={"tab-btn"+(tab==='admin'?' active':'')} onClick={()=>setTab('admin')}>–ê–¥–º–∏–Ω</button>}
          </div>

          {tab==='community'&&(
            <div className="card">
              <div className="hd">
                <h3>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</h3>
                <p className="desc">–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ –∏ –∫—Ä–µ–ø–æ—Å—Ç—å</p>
              </div>
              <div className="bd">
                <div className="grid-2">
                  <button className={"btn "+(pref==='all'?'accent':'')} onClick={()=>setPref('all')}>–í—Å–µ</button>
                  {DIR.map(t=><button key={t} className={"btn "+(pref===t?'accent':'')} onClick={()=>setPref(t)}>{t}</button>)}
                </div>
                <div className="space"></div>
                <div>–ö—Ä–µ–ø–æ—Å—Ç—å: <b>{strength}</b></div>
                <input type="range" min="1" max="10" value={strength} onChange={e=>setStrength(parseInt(e.target.value))}/>
                <div className="sep"></div>
                <div className="grid">
                  {rec.map(m=>(
                    <div key={m.id} className="mix-card">
                      <div className="row between">
                        <div>
                          <div style={{fontWeight:600}}>{m.title}</div>
                          <div className="tiny muted">–ú–∏–∫—Å –æ—Ç {m.author}</div>
                        </div>
                        <button className={"btn "+(likes[m.id]?'accent':'')} onClick={()=>toggleLike(m.id)}>‚ù§ {m.likes}</button>
                      </div>
                      <div className="space"></div>
                      <div className="tiny">–ö—Ä–µ–ø–æ—Å—Ç—å: <b>{m.avgStrength}</b></div>
                      <div className="taste-line">{smartDesc(m.parts)}</div>
                      <div className="tiny muted">–°–æ—Å—Ç–∞–≤: {m.parts.map(p=>p.name+" "+p.percent+"%").join(' + ')}</div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          {tab==='builder'&&(
            <>
              <div className="card">
                <div className="hd"><h3>–ë—Ä–µ–Ω–¥—ã</h3><p className="desc">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥ –∏ –¥–æ–±–∞–≤–ª—è–π—Ç–µ –≤–∫—É—Å—ã</p></div>
                <div className="bd grid">
                  <div className="grid-2">
                    {visibleBrands.map(b=>(
                      <button key={b.id} className={"brand-btn"+(selected===b.id?' active':'')} onClick={()=>setSelected(b.id)}>{b.name}</button>
                    ))}
                  </div>
                </div>
              </div>

              {selectedBrand && (
                <div className="card">
                  <div className="hd"><h3>–í–∫—É—Å—ã ‚Äî {selectedBrand.name}</h3><p className="desc">–î–æ–±–∞–≤—å—Ç–µ –≤–∫—É—Å –≤ –º–∏–∫—Å</p></div>
                  <div className="bd grid">
                    <input className="input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –≤–∫—É—Å–∞–º‚Ä¶" value={search} onChange={e=>setSearch(e.target.value)} />
                    {filtered.map(f=>(
                      <div key={f.id} className="flavor-item">
                        <div>
                          <div style={{fontWeight:600}}>{f.name}</div>
                          <div className="tiny muted">–∫—Ä–µ–ø–æ—Å—Ç—å: {f.strength} ‚Ä¢ –≤–∫—É—Å: {f.taste}</div>
                        </div>
                        <button className="btn" onClick={()=>addFlavor(selectedBrand.id,f)}>+ –≤ –º–∏–∫—Å</button>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              <div className="card">
                <div className="hd"><h3>–í–∞—à –º–∏–∫—Å</h3><p className="desc">–°—É–º–º–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å 100%</p></div>
                <div className="bd grid">
                  {parts.map(p=>(
                    <div key={p.key} className="mix-card">
                      <div className="row between">
                        <div>
                          <div style={{fontWeight:600}}>{p.name}</div>
                          <div className="tiny muted">–∫—Ä–µ–ø–æ—Å—Ç—å: {p.strength} ‚Ä¢ –≤–∫—É—Å: {p.taste}</div>
                        </div>
                        <button className="btn" onClick={()=>removePart(p.key)}>—É–¥–∞–ª–∏—Ç—å</button>
                      </div>
                      <input type="range" min="0" max="100" step="5" value={p.percent} onChange={e=>updatePct(p.key,parseInt(e.target.value))}/>
                      <div className="tiny muted">–¥–æ–ª—è: <b>{p.percent}%</b></div>
                    </div>
                  ))}
                  <div className="sep"></div>
                  <div className="row between tiny muted">
                    <div>–°—É–º–º–∞: <b>{total}%</b> (–æ—Å—Ç–∞–ª–æ—Å—å: <b>{Math.max(0,100-total)}%</b>)</div>
                    <div>–∫—Ä–µ–ø–æ—Å—Ç—å: <b>{avg||0}</b></div>
                  </div>
                  <button className={"btn "+(total===100?'accent':'')} onClick={saveMix} disabled={total!==100}>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
              </div>
            </>
          )}

          {tab==='admin' && IS_ADMIN && (
            <div className="card">
              <div className="hd"><h3>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</h3><p className="desc">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–µ–Ω–¥–∞–º–∏, –≤–∫—É—Å–∞–º–∏ –∏ –∑–∞–ø—Ä–µ—Ç–∞–º–∏</p></div>
              <div className="bd">‚Ä¶—Ç–≤–æ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Ç—É—Ç‚Ä¶</div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
