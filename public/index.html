<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hookah MiniApp</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      background: #000;
      color: #f0e9db;
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 0;
    }
    .center {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      text-align: center;
      font-size: 1.1rem;
      color: #f0e9db;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div id="telegram-check" class="center hidden">
    ‚ùó –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram Mini App (–±–æ—Ç–∞)
  </div>

  <div id="root" class="hidden"></div>

  <script>
    // === Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
    async function initTelegram() {
      try {
        if (!window.Telegram || !window.Telegram.WebApp) {
          console.warn("‚ùå Telegram SDK not found");
          document.getElementById("telegram-check").classList.remove("hidden");
          return;
        }

        const tg = window.Telegram.WebApp;
        tg.ready();

        // –∂–¥—ë–º, –ø–æ–∫–∞ WebApp –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è
        await new Promise(r => setTimeout(r, 150));

        const user = tg.initDataUnsafe?.user || null;
        console.log("‚úÖ Telegram SDK –Ω–∞–π–¥–µ–Ω:", tg);
        console.log("üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑ initDataUnsafe:", user);

        if (!user) {
          document.getElementById("telegram-check").classList.remove("hidden");
          return;
        }

        // –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –∏–º—è –∏ —Ä–æ–ª—å
        const fullName = [user.first_name, user.last_name].filter(Boolean).join(" ") || user.username || `User ${user.id}`;
        const isAdmin = user.username === "Tutenhaman";

        window.HOOKAH_USER = { id: String(user.id), username: user.username || "", name: fullName };
        window.HOOKAH_IS_ADMIN = isAdmin;

        console.log("‚≠ê Admin status:", isAdmin);

        document.getElementById("root").classList.remove("hidden");
        loadReactApp();

      } catch (err) {
        console.error("Telegram init error:", err);
        document.getElementById("telegram-check").classList.remove("hidden");
      }
    }

    // === –ó–∞–≥—Ä—É–∑–∫–∞ React-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ===
    function loadReactApp() {
      const scriptReact = document.createElement("script");
      scriptReact.src = "https://unpkg.com/react@18/umd/react.development.js";
      const scriptDOM = document.createElement("script");
      scriptDOM.src = "https://unpkg.com/react-dom@18/umd/react-dom.development.js";
      const scriptBabel = document.createElement("script");
      scriptBabel.src = "https://unpkg.com/@babel/standalone/babel.min.js";

      document.body.append(scriptReact, scriptDOM, scriptBabel);

      scriptBabel.onload = () => {
        const appScript = document.createElement("script");
        appScript.type = "text/babel";
        appScript.textContent = `
          const { useState } = React;

          function App() {
            const user = window.HOOKAH_USER;
            const isAdmin = window.HOOKAH_IS_ADMIN;
            const [tab, setTab] = useState("mixes");

            return (
              <div style={{maxWidth:"420px",margin:"0 auto",padding:"16px"}}>
                <h2 style={{textAlign:"center",color:"#f0b85a"}}>–ö–∞–ª—å—è–Ω–Ω—ã–π –º–∏–∫—Å–µ—Ä</h2>
                <div style={{textAlign:"center",fontSize:"0.9rem",opacity:0.8,marginBottom:"12px"}}>
                  –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {user.name} {isAdmin ? "‚≠ê" : ""}
                </div>
                <div style={{display:"flex",justifyContent:"space-around",marginBottom:"16px"}}>
                  <button onClick={()=>setTab("mixes")} style={tab==="mixes"?{background:"#f0b85a",color:"#000"}:{background:"#151515",color:"#fff"}}>–ú–∏–∫—Å—ã</button>
                  <button onClick={()=>setTab("builder")} style={tab==="builder"?{background:"#f0b85a",color:"#000"}:{background:"#151515",color:"#fff"}}>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä</button>
                  {isAdmin && <button onClick={()=>setTab("admin")} style={tab==="admin"?{background:"#f0b85a",color:"#000"}:{background:"#151515",color:"#fff"}}>–ê–¥–º–∏–Ω</button>}
                </div>

                {tab==="mixes" && <div>üì¶ –†–∞–∑–¥–µ–ª –º–∏–∫—Å–æ–≤ –≥–æ—Å—Ç–µ–π. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –º–∏–∫—Å—ã.</div>}
                {tab==="builder" && <div>üß© –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –º–∏–∫—Å–æ–≤. –í—ã–±–æ—Ä –±—Ä–µ–Ω–¥–æ–≤ –∏ –≤–∫—É—Å–æ–≤, —Å–æ–∑–¥–∞–Ω–∏–µ –º–∏–∫—Å–æ–≤.</div>}
                {tab==="admin" && isAdmin && <div>‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±—Ä–µ–Ω–¥–∞–º–∏, –≤–∫—É—Å–∞–º–∏ –∏ –∑–∞–ø—Ä–µ—Ç–∞–º–∏.</div>}
              </div>
            );
          }

          ReactDOM.createRoot(document.getElementById("root")).render(<App />);
        `;
        document.body.append(appScript);
      };
    }

    // === –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é ===
    initTelegram();
  </script>
</body>
</html>
