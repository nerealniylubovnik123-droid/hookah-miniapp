<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hookah MiniApp</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
</head>

<body class="bg-black text-white">
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;

    // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–¥–º–∏–Ω–æ–≤ –ø–æ username ---
    const ADMIN_USERNAMES = ["tooman", "hookahboss", "barowner"];
    // üëÜ —Å—é–¥–∞ –¥–æ–±–∞–≤–ª—è–π Telegram username (–±–µ–∑ @)

    // --- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ Telegram –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ---
    function getTelegramUser() {
      let tg = window.Telegram?.WebApp || null;
      let userId = 0;
      let userName = "–ì–æ—Å—Ç—å";
      let username = "";

      try {
        if (tg?.initDataUnsafe?.user) {
          const u = tg.initDataUnsafe.user;
          userId = u.id;
          userName = (u.first_name || "") + (u.last_name ? " " + u.last_name : "");
          username = u.username || "";
        } else if (tg?.initData) {
          const params = new URLSearchParams(tg.initData);
          const userParam = params.get("user");
          if (userParam) {
            const parsed = JSON.parse(userParam);
            userId = parsed.id;
            userName = (parsed.first_name || "") + (parsed.last_name ? " " + parsed.last_name : "");
            username = parsed.username || "";
          }
        }
      } catch (e) {
        console.warn("Telegram init error:", e);
      }

      // –§–æ–ª–±—ç–∫ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
      if (!username && (location.hostname === "localhost" || location.protocol === "file:")) {
        username = "tooman";
        userName = "Admin (offline)";
      }

      return { id: userId, name: userName, username };
    }

    function HookahMiniApp() {
      const [user, setUser] = useState(getTelegramUser());
      const isAdmin = ADMIN_USERNAMES.includes((user.username || "").toLowerCase());
      const [tab, setTab] = useState("community");

      const [mixes, setMixes] = useState([
        {
          id: "m1",
          title: "–õ–µ—Å–Ω—ã–µ —è–≥–æ–¥—ã",
          author: "–ì–æ—Å—Ç—å –ê–Ω—è",
          parts: [
            { name: "Raspberry", percent: 60, strength: 3, taste: "—è–≥–æ–¥–Ω—ã–π, –∫–∏—Å–ª–æ–≤–∞—Ç—ã–π" },
            { name: "Mint", percent: 40, strength: 2, taste: "–º—è—Ç–Ω—ã–π, —Å–≤–µ–∂–∏–π" },
          ],
          avgStrength: 3,
          likes: 0,
          createdAt: Date.now(),
        },
      ]);

      const [parts, setParts] = useState([]);
      const [title, setTitle] = useState("");
      const [desc, setDesc] = useState("");
      const totalPercent = parts.reduce((a, b) => a + b.percent, 0);

      const saveMix = () => {
        if (totalPercent !== 100) return;
        const newMix = {
          id: Date.now().toString(),
          title: title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è",
          description: desc,
          author: user.name || "–ì–æ—Å—Ç—å",
          parts,
          avgStrength: Math.round(
            parts.reduce((a, p) => a + p.percent * p.strength, 0) / 100
          ),
          likes: 0,
          createdAt: Date.now(),
        };
        setMixes([...mixes, newMix]);
        setTitle("");
        setDesc("");
        setParts([]);
      };

      return (
        <div className="max-w-md mx-auto p-4 text-white">
          <header className="text-center mb-4 text-xl font-semibold text-yellow-400">
            –ö–∞–ª—å—è–Ω–Ω—ã–π –ú–∏–∫—Å–µ—Ä
          </header>

          <div className="flex justify-between bg-gray-800 rounded-lg overflow-hidden mb-4">
            <button
              className={`flex-1 py-2 ${tab === "community" ? "bg-yellow-500 text-black" : "text-white"}`}
              onClick={() => setTab("community")}
            >
              –ú–∏–∫—Å—ã
            </button>
            <button
              className={`flex-1 py-2 ${tab === "builder" ? "bg-yellow-500 text-black" : "text-white"}`}
              onClick={() => setTab("builder")}
            >
              –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
            </button>
            {isAdmin && (
              <button
                className={`flex-1 py-2 ${tab === "admin" ? "bg-yellow-500 text-black" : "text-white"}`}
                onClick={() => setTab("admin")}
              >
                –ê–¥–º–∏–Ω
              </button>
            )}
          </div>

          {/* –í–∫–ª–∞–¥–∫–∞ ‚Äî –º–∏–∫—Å—ã */}
          {tab === "community" && (
            <div>
              <h2 className="text-lg font-medium mb-2">–°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –º–∏–∫—Å—ã</h2>
              {mixes.map((m) => (
                <div
                  key={m.id}
                  className="bg-gray-900 p-3 mb-3 rounded-lg border border-gray-700"
                >
                  <div className="flex justify-between">
                    <div>
                      <div className="font-semibold text-yellow-400">{m.title}</div>
                      <div className="text-sm opacity-70">–ú–∏–∫—Å –æ—Ç {m.author}</div>
                    </div>
                    <div className="text-sm opacity-80">
                      –ö—Ä–µ–ø–æ—Å—Ç—å: {m.avgStrength}
                    </div>
                  </div>
                  <div className="text-xs mt-1 opacity-80">
                    {m.parts.map((p) => `${p.name} ${p.percent}%`).join(" + ")}
                  </div>
                </div>
              ))}
            </div>
          )}

          {/* –í–∫–ª–∞–¥–∫–∞ ‚Äî –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä */}
          {tab === "builder" && (
            <div>
              <h2 className="text-lg font-medium mb-2">–°–æ–∑–¥–∞—Ç—å —Å–≤–æ–π –º–∏–∫—Å</h2>
              <div className="bg-gray-900 p-3 rounded-lg border border-gray-700 mb-3">
                <div className="text-sm mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ</div>
                <input
                  value={title}
                  onChange={(e) => setTitle(e.target.value)}
                  className="w-full bg-gray-800 p-2 rounded text-white mb-2"
                />
                <div className="text-sm mb-1">–û–ø–∏—Å–∞–Ω–∏–µ</div>
                <textarea
                  value={desc}
                  onChange={(e) => setDesc(e.target.value)}
                  className="w-full bg-gray-800 p-2 rounded text-white mb-2"
                />
                <button
                  disabled={totalPercent !== 100}
                  onClick={saveMix}
                  className={`w-full py-2 rounded ${totalPercent === 100 ? "bg-yellow-500 text-black" : "bg-gray-700 text-gray-400"}`}
                >
                  –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–∏–∫—Å
                </button>
              </div>
            </div>
          )}

          {/* –í–∫–ª–∞–¥–∫–∞ ‚Äî –∞–¥–º–∏–Ω */}
          {isAdmin && tab === "admin" && (
            <div>
              <h2 className="text-lg font-medium mb-2">–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h2>
              <div className="bg-gray-900 p-3 rounded-lg border border-gray-700">
                <div className="text-sm text-yellow-400 mb-2">
                  –ü—Ä–∏–≤–µ—Ç, {user.name}!
                </div>
                <div className="text-sm opacity-80">
                  –ó–¥–µ—Å—å –±—É–¥—É—Ç —Ñ—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–∫—É—Å–∞–º–∏ –∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏.
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<HookahMiniApp />, document.getElementById("root"));
  </script>
</body>
</html>
